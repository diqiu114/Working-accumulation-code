## 升级流程：

1. 检查升级状态标志
2. 接收数据
   1. 开始接收
   2. 接收一帧
   3. 写入flash
   4. 接收完成
3. 校验APP跳转地址
4. 跳转

## 注意事项

1. bootloader空间大小设置（向量表偏移量）
   1. 权威指南表明：![image-20230302084520659](at32%20bootloader%E5%88%B6%E4%BD%9C%E8%AE%B0%E5%BD%95.assets/image-20230302084520659.png)

即向量偏移量（bootloder空间大小也是这么多），偏移后指向的地址需要为2的n次方

2. 对外设进行复位

3. 对APP地址进行校验

   1. ​     

      ```c
        if(((*(vu32*)(APP_FLASH_START_ADDR+4))&0xFF000000)==0x08000000)	//判断是否为0x08XXXXXX.
      ```

4. 跳转APP前需要更改堆栈指针MSP

   1. 检查栈顶地址是否合法

      ```
      if( ((*(vu32*)appxaddr)-0x20000000) < (SRAM_SIZE*1024) )	//检查栈顶地址是否合法.
      ```

   2. 跳转至APP程序向量表中的记录复位处理的地址处

      ```
      	jumpApp=(iapfun)*(vu32*)(appxaddr+4);				//用户代码区第二个字为程序开始地址(复位地址)		
      ```

   3. 更改堆栈指针（AC6）

      ```
      	__set_MSP(*(vu32*)appxaddr);										//初始化APP堆栈指针(用户代码区的第一个字用于存放栈顶地址)
      ```

   4. 跳转

      ```
      	jumpApp();																		//跳转到APP.
      ```